name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Production Server
    
    steps:
    - name: ğŸš€ Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        command_timeout: 30m
        script: |
          echo "ğŸ¯ Starting deployment to inroche.com.br..."
          
          # Navigate to project directory
          cd /var/www/inroche.com.br
          
          # Check if deploy script exists
          if [ ! -f "./deploy.sh" ]; then
            echo "âŒ Deploy script not found!"
            exit 1
          fi
          
          # Make sure deploy script is executable
          chmod +x ./deploy.sh
          
          # Show current commit before deployment
          echo "ğŸ“ Current commit: $(git rev-parse --short HEAD)"
          
          # Run deployment script
          echo "âš¡ Running deployment script..."
          ./deploy.sh
          
          # Check deployment result
          DEPLOY_EXIT_CODE=$?
          
          if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ†• New commit: $(git rev-parse --short HEAD)"
            echo "ğŸ• Deployed at: $(date)"
            
            # Optional: Check if site is responding
            echo "ğŸŒ Checking site status..."
            if curl -sSf https://inroche.com.br > /dev/null; then
              echo "âœ… Site is responding correctly!"
            else
              echo "âš ï¸ Site might have issues, please check manually"
            fi
          else
            echo "âŒ Deployment failed with exit code: $DEPLOY_EXIT_CODE"
            exit 1
          fi

    - name: ğŸ“± Notify deployment result
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment SUCCESS!"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"
        else
          echo "âŒ Deployment FAILED!"
          echo "ğŸ“¦ Failed commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
        fi